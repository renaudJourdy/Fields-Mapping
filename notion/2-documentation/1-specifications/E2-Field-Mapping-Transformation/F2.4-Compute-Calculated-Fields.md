**Epic:** E2 â€“ Field Mapping & Transformation  
**Depends on:** F2.2 (Apply Direct Field Mappings), F2.3 (Apply Priority Rules)  
**Related Features:** F2.5 (Transform Fields with Static Data)

---

## 1. Description

Compute calculated fields that are derived from telemetry data (e.g., cardinal direction from heading, value change tracking, aggregated metrics).

### 1.1 Purpose

Create Fleeti fields that don't exist directly in provider telemetry but can be computed from existing telemetry fields. Enables derived insights and standardized field formats.

### 1.2 Context

After direct and prioritized fields are mapped (F2.2, F2.3), calculated fields are computed from the mapped telemetry data. These fields add value beyond what providers directly provide.

### 1.3 Value Proposition

Enables derived fields that provide additional insights (e.g., cardinal direction, value change timestamps) and standardized formats that improve frontend consumption.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Calculation Types:**
- **Derivation**: Transform one field into another (heading â†’ cardinal direction)
- **Aggregation**: Combine values over time (daily driving duration)
- **Lookup**: Resolve values from external catalogs (driver ID from hardware key)
- **Value Change Tracking**: Compare current vs previous to compute `last_changed_at`

**Calculation Rules:**
- Calculations defined in configuration
- Dependencies must be available (calculated fields depend on other fields)
- Handle missing dependencies gracefully (set to null or use default)

**Examples:**
- `location.cardinal_direction` = Derived from `location.heading` (0-359Â° â†’ N, NE, E, etc.)
- `location.last_changed_at` = Timestamp when position changed significantly (threshold filters GPS jitter)
- `power.ignition_last_changed_at` = Timestamp when ignition state changed
- `driver.id.value` = Lookup `hardware_key.value` in Fleeti driver catalog

### 2.2 States & Behaviors

**Calculation States:**
- **Computed**: All dependencies available, calculation successful
- **Partial**: Some dependencies missing, use defaults or null
- **Failed**: Calculation error, log and set to null

### 2.3 Edge Cases

- **Missing Dependencies**: Set calculated field to null or use default
- **Calculation Error**: Log error, set to null
- **Invalid Input Values**: Validate inputs, handle gracefully
- **Circular Dependencies**: Detect and prevent

---

## 3. Technical Specification

### 3.1 Inputs

- **Mapped Telemetry**: Direct and prioritized fields from F2.2, F2.3
- **Previous Telemetry**: Previous packet for change tracking
- **External Services**: Driver catalog, geofence service (for lookups)
- **Calculation Configuration**: Calculation rules from F2.1

### 3.2 Processing Logic

1. For each calculated field in configuration:
   - Check dependencies are available
   - Execute calculation logic
   - Handle errors gracefully
   - Set Fleeti field value
2. Handle missing dependencies (set to null or use default)

### 3.3 Outputs

- **Calculated Fields**: Computed Fleeti fields
- **Calculation Results**: Success/failure for each calculation

### 3.4 Data Structures

```json
{
  "location": {
    "heading": 92.0,
    "cardinal_direction": "E"
  },
  "power": {
    "ignition": true,
    "ignition_last_changed_at": 1234567890123
  }
}
```

---

## 4. Integration & Contracts

### 4.3 External Service Integration

**Service:** Driver Catalog  
**Integration Type:** Lookup API  
**Usage:** Lookup driver ID from hardware key

**Service:** Geofence Service  
**Integration Type:** Computation  
**Usage:** Determine current geofences from location

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Calculated fields must meet data quality standards. See data quality documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

Calculation failures should be logged and handled gracefully. See error handling documentation.

---

## 6. Acceptance Criteria

### AC1 â€“ Compute Calculated Fields

**Given** mapped telemetry and calculation configuration  
**When** computing calculated fields  
**Then** calculated fields are computed correctly

### AC2 â€“ Handle Missing Dependencies

**Given** a calculated field has missing dependencies  
**When** computing the field  
**Then** field is set to null or uses default value

### AC3 â€“ Track Value Changes

**Given** current and previous telemetry packets  
**When** computing `last_changed_at` fields  
**Then** timestamps are computed when values change

---

## 7. Performance Requirements

- **Latency:** Calculation < 10ms per field
- **Throughput:** Handle calculations at transformation rate
- **External Lookups:** Cache lookup results for performance

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Calculation logic for each calculated field type
- Missing dependency handling
- Value change tracking
- External lookup integration

### 8.2 Integration Tests

- End-to-end calculation with real packets
- Multiple calculated fields
- External service integration

---

## 9. References

### 9.1 Related Documentation

- **[Epic 2 Overview](./README.md)**: Epic context
- **[ðŸ”€ Mapping Fields Database](../databases/mapping-fields/README.md)**: Calculation rules

---

## 10. Non-Goals

- Static data transformations (covered by F2.5)
- I/O mappings (covered by F2.6)

---

## 11. Open Questions

1. What calculations should be implemented in code vs configuration?
2. How should external lookup failures be handled?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

