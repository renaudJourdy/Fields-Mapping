# F2.5 – Transform Fields with Static Data

**Epic:** E2 – Field Mapping & Transformation  
**Depends on:** F2.4 (Compute Calculated Fields), Asset Service  
**Related Features:** F2.6 (Map I/O to Semantic Fields)

---

## 1. Description

Transform telemetry fields by combining them with static asset metadata (e.g., fuel level percentage → liters using tank capacity, sensor identity from installation metadata).

### 1.1 Purpose

Create Fleeti fields that combine telemetry data with static asset configuration. Enables transformations like converting percentages to absolute values using asset specifications.

### 1.2 Context

After calculated fields are computed (F2.4), transformed fields combine telemetry with static data from Asset Service. These transformations require both telemetry and asset metadata.

### 1.3 Value Proposition

Enables richer telemetry fields by combining real-time data with asset specifications. Provides absolute values (liters, hours) in addition to relative values (percentages).

---

## 2. Business Logic

### 2.1 Rules & Priority

**Transformation Types:**
- **Percentage to Absolute**: Fuel level % → liters using tank capacity
- **Sensor Identity**: Combine sensor readings with installation metadata
- **Unit Conversion with Asset Data**: Convert using asset-specific factors

**Static Data Sources:**
- **Asset Specifications**: Tank capacity, engine size, etc.
- **Installation Metadata**: I/O wiring, sensor positions, accessory mappings
- **Customer Settings**: Custom thresholds, preferences

**Transformation Rules:**
- Transformations defined in configuration
- Static data retrieved from Asset Service
- Handle missing static data gracefully (use default or set to null)

**Examples:**
- `fuel.level_liters` = `fuel.level_percent` * `asset.properties.vehicle.powertrain.fuel_tank_capacity.value` / 100
- `sensors.environment[].label` = From `asset.accessories[].sensors[]` metadata

### 2.2 States & Behaviors

**Transformation States:**
- **Transformed**: Static data available, transformation successful
- **Partial**: Some static data missing, use defaults or null
- **Failed**: Transformation error, log and set to null

### 2.3 Edge Cases

- **Missing Static Data**: Use default value or set to null
- **Invalid Static Data**: Log warning, use default or null
- **Asset Service Unavailable**: Use cached data or default
- **Transformation Error**: Log error, set to null

---

## 3. Technical Specification

### 3.1 Inputs

- **Mapped Telemetry**: Telemetry fields from F2.2-F2.4
- **Asset Service**: Installation metadata and asset specifications
- **Transformation Configuration**: Transformation rules from F2.1

### 3.2 Processing Logic

1. For each transformed field in configuration:
   - Retrieve static data from Asset Service
   - Combine telemetry with static data
   - Execute transformation logic
   - Set Fleeti field value
2. Handle missing static data (use default or null)
3. Cache static data for performance

### 3.3 Outputs

- **Transformed Fields**: Fleeti fields with static data transformations
- **Transformation Results**: Success/failure for each transformation

### 3.4 Data Structures

```json
{
  "fuel": {
    "level_percent": 75,
    "level_liters": 90
  },
  "sensors": {
    "environment": [
      {
        "id": "sensor-001",
        "label": "Cold room sensor",
        "temperature": { "value": -18.5, "unit": "°C" }
      }
    ]
  }
}
```

---

## 4. Integration & Contracts

### 4.3 External Service Integration

**Service:** Asset Service  
**Integration Type:** REST API  
**Usage:** Retrieve installation metadata and asset specifications  
**Authentication:** Internal service authentication

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Transformed fields must meet data quality standards. See data quality documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

Transformation failures should be logged and handled gracefully. Asset Service failures should use cached data or defaults. See error handling documentation.

---

## 6. Acceptance Criteria

### AC1 – Transform Fields with Static Data

**Given** telemetry and static asset data  
**When** applying transformations  
**Then** transformed fields are computed correctly

### AC2 – Handle Missing Static Data

**Given** static data is missing  
**When** applying transformation  
**Then** field uses default value or is set to null

### AC3 – Cache Static Data

**Given** static data is retrieved from Asset Service  
**When** processing multiple packets  
**Then** static data is cached for performance

---

## 7. Performance Requirements

- **Latency:** Transformation < 10ms per field (with caching)
- **Throughput:** Handle transformations at transformation rate
- **Asset Service Calls:** Minimize calls through caching

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Transformation logic for each type
- Missing static data handling
- Asset Service integration
- Caching behavior

### 8.2 Integration Tests

- End-to-end transformation with real packets and Asset Service
- Multiple transformed fields
- Asset Service failure scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 2 Overview](./README.md)**: Epic context
- **[Mapping Fields Database](../databases/mapping-fields/README.md)**: Transformation rules

---

## 10. Non-Goals

- I/O mappings (covered by F2.6)
- Asset Service API definition (external service)

---

## 11. Open Questions

1. What is the Asset Service API structure?
2. How should static data caching be implemented?
3. What is the cache invalidation strategy?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

