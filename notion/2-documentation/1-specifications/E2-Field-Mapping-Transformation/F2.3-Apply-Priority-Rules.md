**Epic:** E2 â€“ Field Mapping & Transformation  
**Depends on:** F2.2 (Apply Direct Field Mappings)  
**Related Features:** F2.4 (Compute Calculated Fields)

---

## 1. Description

Select the best source field from multiple provider fields based on priority chains when multiple provider fields represent the same Fleeti telemetry concept.

### 1.1 Purpose

When multiple provider fields represent the same Fleeti field (e.g., CAN speed, OBD speed, GPS speed), select the best available source based on priority rules. Enables fallback to less accurate sources when preferred sources are unavailable.

### 1.2 Context

After direct mappings (F2.2), priority rules handle cases where multiple provider fields map to the same Fleeti field. The system selects the highest-priority non-null value available.

### 1.3 Value Proposition

Ensures the most accurate telemetry values are used while providing fallbacks when preferred sources are unavailable. Supports customer-specific priority preferences.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Priority Chain Rules:**
- Evaluate provider fields in priority order (highest to lowest)
- Select first non-null value found
- If all sources are null, set Fleeti field to null

**Example Priority Chains:**
- **Speed**: `can_speed` > `obd_speed` > `speed` (GPS)
- **RPM**: `can_rpm` > `obd_rpm` > `avl_io_85`
- **Odometer**: `can_mileage` > `hw_mileage` > `avl_io_105`

**Configuration Override:**
- Customer/asset can override priority chain
- Example: Customer A prefers OBD speed over CAN speed

### 2.2 States & Behaviors

**Priority Selection:**
- **Found**: Highest-priority field available, value selected
- **Fallback**: Higher-priority fields null, lower-priority field used
- **Missing**: All fields null, Fleeti field set to null

### 2.3 Edge Cases

- **All Fields Null**: Set Fleeti field to null
- **Invalid Values**: Skip invalid values, try next priority
- **Priority Override**: Use customer/asset-specific priority chain

---

## 3. Technical Specification

### 3.1 Inputs

- **Provider Fields**: Provider-agnostic telemetry structure
- **Priority Configuration**: Priority chains from F2.1

### 3.2 Processing Logic

1. For each prioritized Fleeti field:
   - Load priority chain from configuration
   - Evaluate provider fields in priority order
   - Select first non-null value
   - Set Fleeti field value
2. Handle all-null case (set to null)

### 3.3 Outputs

- **Fleeti Fields**: Prioritized fields populated
- **Source Used**: Which provider field was selected (for traceability)

### 3.4 Data Structures

```json
{
  "motion": {
    "speed": 45.2,
    "speed_source": "can_speed"
  }
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Mapping Fields Database  
**Usage:** Reference priority chain rules

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Selected values must meet data quality standards. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 â€“ Apply Priority Rules

**Given** multiple provider fields for a Fleeti field  
**When** applying priority rules  
**Then** highest-priority non-null value is selected

### AC2 â€“ Handle Fallback

**Given** higher-priority fields are null  
**When** applying priority rules  
**Then** lower-priority field is used

### AC3 â€“ Handle All Null

**Given** all provider fields are null  
**When** applying priority rules  
**Then** Fleeti field is set to null

---

## 7. Performance Requirements

- **Latency:** Priority selection < 5ms per field
- **Throughput:** Handle priority selection at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Priority chain evaluation
- Fallback behavior
- All-null handling
- Customer-specific overrides

### 8.2 Integration Tests

- End-to-end priority selection with real packets
- Multiple prioritized fields
- Configuration override scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 2 Overview](./README.md)**: Epic context
- **[ðŸ”€ Mapping Fields Database](../databases/mapping-fields/README.md)**: Priority chain rules

---

## 10. Non-Goals

- Direct mappings (covered by F2.2)
- Calculated fields (covered by F2.4)

---

## 11. Open Questions

1. Should source traceability be stored?
2. How should invalid values in priority chain be handled?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

