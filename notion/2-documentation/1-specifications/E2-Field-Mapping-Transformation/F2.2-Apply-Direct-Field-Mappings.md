# F2.2 – Apply Direct Field Mappings

**Epic:** E2 – Field Mapping & Transformation  
**Depends on:** F2.1 (Load Hierarchical Configuration)  
**Related Features:** F2.3 (Apply Priority Rules), F2.4 (Compute Calculated Fields)

---

## 1. Description

Apply direct field mappings (1:1 provider field → Fleeti field) with optional unit conversion.

### 1.1 Purpose

Map provider fields directly to Fleeti fields when there's a 1:1 correspondence. Handle unit conversion when provider and Fleeti use different units.

### 1.2 Context

After configuration is loaded (F2.1), direct mappings are the simplest transformation - copying provider field values to Fleeti fields, optionally converting units.

### 1.3 Value Proposition

Enables straightforward field mapping for fields that have direct correspondence between provider and Fleeti formats.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Direct Mapping Rules:**
- 1:1 mapping: One provider field → one Fleeti field
- Unit conversion: Convert units if provider and Fleeti differ (e.g., km/h → m/s)
- Type conversion: Convert data types if needed (e.g., string → number)

**Unit Conversion:**
- Convert units according to configuration
- Preserve precision during conversion
- Handle conversion errors gracefully

### 2.2 States & Behaviors

**Mapping States:**
- **Mapped**: Provider field exists and mapped successfully
- **Missing**: Provider field not present, Fleeti field set to null
- **Conversion Error**: Unit conversion failed, use default or mark unavailable

### 2.3 Edge Cases

- **Missing Provider Field**: Set Fleeti field to null
- **Invalid Value**: Log warning, set to null or use default
- **Unit Conversion Error**: Log error, use original value or null
- **Type Mismatch**: Attempt type conversion, fail gracefully if not possible

---

## 3. Technical Specification

### 3.1 Inputs

- **Provider Fields**: Provider-agnostic telemetry structure from Epic 1
- **Configuration**: Direct mapping rules from F2.1

### 3.2 Processing Logic

1. For each direct mapping in configuration:
   - Find provider field in telemetry
   - Apply unit conversion if configured
   - Apply type conversion if needed
   - Set Fleeti field value
2. Handle missing fields (set to null)
3. Handle conversion errors (log and use default/null)

### 3.3 Outputs

- **Fleeti Fields**: Directly mapped fields populated
- **Mapping Results**: Success/failure for each mapping

### 3.4 Data Structures

```json
{
  "location": {
    "latitude": 14.6661,
    "longitude": -17.0712
  }
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Mapping Fields Database  
**Usage:** Reference direct mapping rules

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Mapped fields must meet data quality standards. See data quality documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

Mapping failures should be logged and handled gracefully. See error handling documentation.

---

## 6. Acceptance Criteria

### AC1 – Apply Direct Mappings

**Given** provider telemetry and direct mapping configuration  
**When** applying direct mappings  
**Then** provider fields are mapped to Fleeti fields correctly

### AC2 – Handle Unit Conversion

**Given** a provider field requires unit conversion  
**When** applying mapping  
**Then** unit conversion is applied correctly

### AC3 – Handle Missing Fields

**Given** a provider field is missing  
**When** applying mapping  
**Then** Fleeti field is set to null

---

## 7. Performance Requirements

- **Latency:** Direct mapping < 5ms per packet
- **Throughput:** Handle mapping at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Direct mapping with valid fields
- Unit conversion
- Missing field handling
- Type conversion

### 8.2 Integration Tests

- End-to-end direct mapping with real packets
- Multiple direct mappings
- Error scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 2 Overview](./README.md)**: Epic context
- **[Mapping Fields Database](../databases/mapping-fields/README.md)**: Mapping rules

---

## 10. Non-Goals

- Priority rules (covered by F2.3)
- Calculated fields (covered by F2.4)

---

## 11. Open Questions

1. What unit conversions are needed?
2. How should invalid values be handled?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

