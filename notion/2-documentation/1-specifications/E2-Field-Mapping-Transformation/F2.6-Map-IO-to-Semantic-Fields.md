**Epic:** E2 – Field Mapping & Transformation  
**Depends on:** F2.5 (Transform Fields with Static Data), Asset Service  
**Related Features:** All Epic 2 features (I/O mapping is part of transformation)

---

## 1. Description

Map raw I/O signals (digital inputs/outputs, analog inputs) to semantic Fleeti fields based on installation metadata (e.g., input_1 → ignition, output_2 → immobilizer relay).

### 1.1 Purpose

Convert raw device I/O states into semantic, meaningful fields. The same physical input can represent different things (ignition, door sensor, etc.) depending on installation configuration.

### 1.2 Context

After transformed fields are computed (F2.5), I/O mappings convert raw I/O signals to semantic fields. Installation metadata defines which I/O represents which function.

### 1.3 Value Proposition

Enables semantic field computation from raw I/O signals. Supports flexible installations where the same device input can be wired to different vehicle functions.

---

## 2. Business Logic

### 2.1 Rules & Priority

**I/O Mapping Rules:**
- **Digital Inputs**: `io.inputs.individual.input_N` → semantic field based on `asset.installation.ignition_input_number`
- **Digital Outputs**: `io.outputs.individual.output_N` → semantic field based on `asset.installation.immobilizer_output_number`
- **Analog Inputs**: `io.analog.input_N` → semantic field based on installation metadata

**Bitmask Extraction:**
- Some I/O comes as bitmasks (`din`, `outputs`)
- Extract individual bits based on position (bit 0 → input_1, bit 1 → input_2)

**Default Fallbacks:**
- If installation metadata missing, use default mapping from configuration
- Example: Default `input_1` = ignition (if installation metadata not available)

**Examples:**
- `io.inputs.individual.input_1` + `asset.installation.ignition_input_number = 1` → `power.ignition`
- `io.outputs.individual.output_2` + `asset.installation.immobilizer_output_number = 2` → `diagnostics.security.immobilizer.*`
- `io.analog.input_1` + installation metadata → `fuel.levels[]` or `sensors.environment[].temperature`

### 2.2 States & Behaviors

**Mapping States:**
- **Mapped**: Installation metadata available, mapping successful
- **Default**: Installation metadata missing, using default mapping
- **Failed**: Mapping error, log and set to null

### 2.3 Edge Cases

- **Missing Installation Metadata**: Use default mapping from configuration
- **Invalid I/O Values**: Log warning, set to null
- **Bitmask Extraction**: Extract bits correctly, handle missing bits
- **Multiple I/O Mappings**: Handle multiple I/O → one semantic field

---

## 3. Technical Specification

### 3.1 Inputs

- **Raw I/O Fields**: `io.inputs.individual.*`, `io.outputs.individual.*`, `io.analog.*`
- **Installation Metadata**: From Asset Service (`asset.installation.*`)
- **I/O Mapping Configuration**: Default mappings and rules from F2.1

### 3.2 Processing Logic

1. For each I/O field:
   - Retrieve installation metadata from Asset Service
   - Determine semantic meaning from metadata
   - Extract value from I/O (direct or bitmask)
   - Map to semantic Fleeti field
2. Handle missing metadata (use default mapping)
3. Handle bitmask extraction

### 3.3 Outputs

- **Semantic Fields**: I/O mapped to semantic Fleeti fields
- **Mapping Results**: Success/failure for each mapping

### 3.4 Data Structures

```json
{
  "power": {
    "ignition": true
  },
  "diagnostics": {
    "body": {
      "doors": {
        "front_left": false
      }
    }
  }
}
```

---

## 4. Integration & Contracts

### 4.3 External Service Integration

**Service:** Asset Service  
**Integration Type:** REST API  
**Usage:** Retrieve installation metadata (`asset.installation.*`)  
**Authentication:** Internal service authentication

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

I/O mapped fields must meet data quality standards. See data quality documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

I/O mapping failures should use default mappings or set to null. See error handling documentation.

---

## 6. Acceptance Criteria

### AC1 – Map I/O to Semantic Fields

**Given** raw I/O fields and installation metadata  
**When** applying I/O mappings  
**Then** I/O fields are mapped to semantic Fleeti fields correctly

### AC2 – Handle Missing Metadata

**Given** installation metadata is missing  
**When** applying I/O mappings  
**Then** default mapping from configuration is used

### AC3 – Extract Bitmasks

**Given** I/O comes as bitmask  
**When** applying I/O mappings  
**Then** individual bits are extracted correctly

---

## 7. Performance Requirements

- **Latency:** I/O mapping < 5ms per field
- **Throughput:** Handle mapping at transformation rate
- **Asset Service Calls:** Cache installation metadata

---

## 8. Testing Strategy

### 8.1 Unit Tests

- I/O mapping with installation metadata
- Default mapping fallback
- Bitmask extraction
- Multiple I/O → one semantic field

### 8.2 Integration Tests

- End-to-end I/O mapping with real packets and Asset Service
- Installation metadata retrieval
- Default mapping scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 2 Overview](./README.md)**: Epic context
- **[Mapping Fields Database](../databases/mapping-fields/README.md)**: I/O mapping rules
- **[Schema Specification](../../../docs/legacy/fleeti-telemetry-schema-specification.md)**: I/O field structure

---

## 10. Non-Goals

- I/O field definition (covered in schema specification)
- Installation metadata management (Asset Service responsibility)

---

## 11. Open Questions

1. What is the exact bitmask format?
2. How should conflicting I/O mappings be handled?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

