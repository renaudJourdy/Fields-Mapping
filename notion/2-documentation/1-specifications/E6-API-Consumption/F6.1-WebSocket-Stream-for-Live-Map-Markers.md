# F6.1 – WebSocket Stream for Live Map Markers

**Epic:** E6 – API & Consumption  
**Depends on:** E3 (status computation), E4 (hot storage)  
**Related Features:** F6.4 (API Authentication), F6.5 (Rate Limiting)

---

## 1. Description

Provide real-time marker updates for live map via WebSocket stream. Stream delivers top_status, position, heading, and status information needed for marker rendering.

### 1.1 Purpose

Enable real-time marker updates on live map. WebSocket stream provides low-latency updates (< 100ms) for marker display with status-based iconography.

### 1.2 Context

Frontend live map requires real-time marker updates. WebSocket stream queries hot storage and streams updates to connected clients. Stream format is defined in WebSocket contracts.

### 1.3 Value Proposition

Enables smooth, real-time marker updates on live map. Critical for frontend marker rendering and live tracking experience.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Stream Rules:**
- Stream name: `live.map.markers`
- Stream version: `v1`
- Update frequency: Configurable (default: 5 Hz)
- Viewport filtering: Stream only markers in viewport

**Message Types:**
- **Subscribe**: Client subscribes to stream
- **Snapshot**: Initial full state
- **Delta**: Incremental updates
- **Update**: Client updates viewport/zoom
- **Error**: Error messages
- **Resync**: Resync request

**Field Inclusion:**
- `top_status` (from Epic 3)
- `statuses[]` (from Epic 3)
- `location.latitude`, `location.longitude`
- `location.heading`
- `asset.id`, `asset.type`
- Additional fields as defined in WebSocket contract

### 2.2 States & Behaviors

**Stream States:**
- **Subscribed**: Client subscribed, receiving updates
- **Unsubscribed**: Client unsubscribed
- **Error**: Stream error, client disconnected

**Behaviors:**
- Stream updates when telemetry changes
- Filter by viewport and zoom level
- Rate limit updates per client
- Handle client disconnections gracefully

### 2.3 Edge Cases

- **Client Disconnection**: Clean up subscriptions
- **Viewport Changes**: Update stream filter
- **Rate Limiting**: Throttle updates if needed
- **Storage Unavailable**: Stream cached data or error

---

## 3. Technical Specification

### 3.1 Inputs

- **Hot Storage**: Core fields from Epic 4 (F4.1)
- **Status**: Top status and statuses from Epic 3
- **Client Subscription**: Viewport, zoom, rate limit preferences

### 3.2 Processing Logic

1. Client subscribes to stream
2. Query hot storage for markers in viewport
3. Send snapshot (initial state)
4. Stream delta updates when telemetry changes
5. Handle viewport updates
6. Handle client disconnections

### 3.3 Outputs

- **WebSocket Messages**: Snapshot, delta, error, resync messages
- **Stream Status**: Subscription status, error status

### 3.4 Data Structures

[See WebSocket contract specification for exact message formats]

---

## 4. Integration & Contracts

### 4.1 API Contracts

**WebSocket Contract:** [`../websocket-contracts/live-map-markers.md`](../websocket-contracts/live-map-markers.md)

Detailed WebSocket contract specification including message formats, subscription parameters, and field definitions.

### 4.3 External Service Integration

**Service:** Hot Storage (Epic 4)  
**Integration Type:** Storage query API  
**Usage:** Query core fields for marker updates

---

## 5. Cross-Cutting Concerns

### 5.1 Security

**Reference:** [`../../7-security/README.md`](../../7-security/README.md)

WebSocket connections must be authenticated. See security documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

WebSocket errors must be handled gracefully. See error handling documentation.

### 5.4 Monitoring & Observability

**Reference:** [`../../5-operations/monitoring-observability.md`](../../5-operations/monitoring-observability.md)

Must emit metrics: `telemetry.websocket.connections`, `telemetry.websocket.messages.sent`, `telemetry.websocket.latency`. See monitoring documentation.

---

## 6. Acceptance Criteria

### AC1 – Stream Real-Time Updates

**Given** client is subscribed to stream  
**When** telemetry updates occur  
**Then** delta updates are streamed to client

### AC2 – Meet Latency Requirements

**Given** telemetry update occurs  
**When** streaming to client  
**Then** update latency is < 100ms

### AC3 – Filter by Viewport

**Given** client updates viewport  
**When** streaming markers  
**Then** only markers in viewport are streamed

---

## 7. Performance Requirements

- **Latency:** < 100ms for marker updates
- **Throughput:** Handle concurrent WebSocket connections
- **Update Frequency:** Configurable (default: 5 Hz)

---

## 8. Testing Strategy

### 8.1 Unit Tests

- WebSocket stream logic
- Message formatting
- Viewport filtering

### 8.2 Integration Tests

- End-to-end WebSocket streaming with real data
- Hot storage integration
- Client connection/disconnection scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 6 Overview](./README.md)**: Epic context
- **[WebSocket Contracts](../websocket-contracts/live-map-markers.md)**: Detailed contract specification
- **[Epic 3 - Status Computation](../E3-Status-Computation/F3.5-Compute-Top-Status.md)**: Top status computation

---

## 10. Non-Goals

- REST API endpoints (covered by F6.2, F6.3)
- Authentication implementation (covered by F6.4)

---

## 11. Open Questions

1. What is the exact WebSocket message format?
2. How should viewport filtering be optimized?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

