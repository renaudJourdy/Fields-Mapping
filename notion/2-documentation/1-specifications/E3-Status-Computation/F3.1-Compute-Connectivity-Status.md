# F3.1 – Compute Connectivity Status

**Epic:** E3 – Status Computation  
**Depends on:** E2 (transformed Fleeti fields, especially `last_updated_at`)  
**Related Features:** F3.5 (Compute Top Status)

---

## 1. Description

Compute Connectivity status (online/offline) based on `last_updated_at` timestamp and threshold.

### 1.1 Purpose

Determine whether an asset is currently connected and sending telemetry. Connectivity status is the highest-priority status family and overrides all other statuses when offline.

### 1.2 Context

Connectivity status is computed first as it has highest priority. If an asset is offline, other status families are not evaluated (offline overrides everything).

### 1.3 Value Proposition

Enables detection of connectivity issues and ensures offline assets are clearly identified. Critical for marker display (offline markers show no-connectivity icon).

---

## 2. Business Logic

### 2.1 Rules & Priority

**Connectivity Rules:**
- **Online**: `last_updated_at` is within threshold (e.g., 5 minutes)
- **Offline**: `last_updated_at` is beyond threshold

**Threshold:**
- Configurable threshold (default: 5 minutes)
- Threshold may vary by asset type or customer

**Priority:**
- Connectivity has highest priority in status hierarchy
- Offline status overrides all other status families

### 2.2 States & Behaviors

**Connectivity States:**
- **online**: Asset is connected and sending telemetry
- **offline**: Asset has not sent telemetry within threshold

**State Transitions:**
- **online → offline**: `last_updated_at` exceeds threshold
- **offline → online**: New telemetry packet received

### 2.3 Edge Cases

- **Missing last_updated_at**: Assume offline (safety)
- **Future Timestamps**: Clamp to current time, log warning
- **Threshold Configuration**: Use customer/asset-specific threshold if configured

---

## 3. Technical Specification

### 3.1 Inputs

- **last_updated_at**: Root-level timestamp from Fleeti telemetry
- **Current Time**: Server current timestamp
- **Threshold Configuration**: Connectivity threshold from configuration

### 3.2 Processing Logic

1. Get `last_updated_at` from telemetry
2. Calculate time difference: `current_time - last_updated_at`
3. Compare with threshold
4. If difference > threshold: status = offline
5. If difference ≤ threshold: status = online
6. Return connectivity status

### 3.3 Outputs

- **Connectivity Status**: `{ family: "connectivity", code: "online" | "offline", last_changed_at: number }`
- **Compatibility**: Always compatible (applies to all asset types)

### 3.4 Data Structures

```json
{
  "family": "connectivity",
  "code": "online",
  "last_changed_at": 1234567890123
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Fleeti Fields Database  
**Usage:** Reference `last_updated_at` field definition

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Missing or invalid `last_updated_at` must be handled. See data quality documentation.

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

If `last_updated_at` is missing, assume offline for safety. See error handling documentation.

---

## 6. Acceptance Criteria

### AC1 – Compute Online Status

**Given** `last_updated_at` is within threshold  
**When** computing connectivity status  
**Then** status is "online"

### AC2 – Compute Offline Status

**Given** `last_updated_at` exceeds threshold  
**When** computing connectivity status  
**Then** status is "offline"

### AC3 – Track Status Changes

**Given** connectivity status changes  
**When** computing status  
**Then** `last_changed_at` timestamp is updated

---

## 7. Performance Requirements

- **Latency:** Connectivity computation < 1ms
- **Throughput:** Handle computation at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Online status with recent timestamp
- Offline status with old timestamp
- Threshold boundary conditions
- Missing timestamp handling

### 8.2 Integration Tests

- End-to-end connectivity computation with real telemetry
- Status transition scenarios
- Threshold configuration

---

## 9. References

### 9.1 Related Documentation

- **[Epic 3 Overview](./README.md)**: Epic context
- **[Status Rules](./status-rules.md)**: Connectivity status rules (legacy reference)

---

## 10. Non-Goals

- Other status families (covered by F3.2-F3.4)
- Top status computation (covered by F3.5)

---

## 11. Open Questions

1. What is the exact connectivity threshold?
2. Should threshold be configurable per customer/asset?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

