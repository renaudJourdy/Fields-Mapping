**Epic:** E3 – Status Computation  
**Depends on:** E2 (transformed Fleeti fields: engine signals)  
**Related Features:** F3.5 (Compute Top Status)

---

## 1. Description

Compute Engine status (running/standby) based on engine diagnostic signals (RPM, engine running indicators).

### 1.1 Purpose

Determine whether an asset's engine is currently running or in standby. Engine status is used for marker display and fuel consumption tracking.

### 1.2 Context

Engine status is computed after Connectivity and Immobilization (if online and not immobilized). It has higher priority than Transit status.

### 1.3 Value Proposition

Enables accurate engine state detection for marker display and operational insights. Provides consistent engine status regardless of provider.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Engine Rules:**
- **running**: Engine is actually running (RPM > threshold OR engine running indicator = true)
- **standby**: Engine is not running (RPM ≤ threshold AND engine running indicator = false)

**Compatibility:**
- Applies to assets with engines (vehicles, equipment)
- Does not apply to sites or phones

**Priority:**
- Engine has higher priority than Transit
- Lower priority than Immobilization

### 2.2 States & Behaviors

**Engine States:**
- **running**: Engine is running
- **standby**: Engine is not running

**State Transitions:**
- **standby → running**: Engine starts (RPM increases or indicator changes)
- **running → standby**: Engine stops (RPM decreases or indicator changes)

### 2.3 Edge Cases

- **Missing RPM**: Use engine running indicator if available
- **Missing Engine Indicator**: Use RPM if available
- **Conflicting Signals**: Prefer engine running indicator over RPM

---

## 3. Technical Specification

### 3.1 Inputs

- **diagnostics.engine.running.value**: Engine running indicator
- **diagnostics.engine.rpm**: Engine RPM
- **asset.type**: Asset type (for compatibility)

### 3.2 Processing Logic

1. Check asset type compatibility (engines only)
2. Evaluate engine running indicator if available
3. Fallback to RPM threshold if indicator unavailable
4. Determine engine status
5. Return engine status

### 3.3 Outputs

- **Engine Status**: `{ family: "engine", code: "running" | "standby", last_changed_at: number }`
- **Compatibility**: Assets with engines only

### 3.4 Data Structures

```json
{
  "family": "engine",
  "code": "running",
  "last_changed_at": 1234567890123
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Fleeti Fields Database  
**Usage:** Reference engine diagnostic fields

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Missing engine fields must be handled with fallbacks. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 – Compute Running Status

**Given** engine is running  
**When** computing engine status  
**Then** status is "running"

### AC2 – Compute Standby Status

**Given** engine is not running  
**When** computing engine status  
**Then** status is "standby"

### AC3 – Handle Missing Fields

**Given** engine running indicator is missing  
**When** computing engine status  
**Then** fallback to RPM threshold logic

---

## 7. Performance Requirements

- **Latency:** Engine computation < 2ms
- **Throughput:** Handle computation at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Running with engine indicator
- Standby with engine indicator
- Fallback to RPM
- Asset type compatibility

### 8.2 Integration Tests

- End-to-end engine computation with real telemetry
- Status transition scenarios
- Missing field fallbacks

---

## 9. References

### 9.1 Related Documentation

- **[Epic 3 Overview](./README.md)**: Epic context
- **[Status Rules](./status-rules.md)**: Engine status rules (legacy reference)

---

## 10. Non-Goals

- Other status families (covered by F3.1, F3.2, F3.4)
- Top status computation (covered by F3.5)

---

## 11. Open Questions

1. What is the exact RPM threshold for engine running?
2. How should conflicting engine signals be resolved?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

