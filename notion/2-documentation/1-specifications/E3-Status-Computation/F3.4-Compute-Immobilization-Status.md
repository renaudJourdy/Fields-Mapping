# F3.4 – Compute Immobilization Status

**Epic:** E3 – Status Computation  
**Depends on:** E2 (transformed Fleeti fields: immobilizer signals, asset metadata)  
**Related Features:** F3.5 (Compute Top Status)

---

## 1. Description

Compute Immobilization status (immobilized/immobilizing/releasing/free) based on immobilizer signals and asset capability.

### 1.1 Purpose

Determine immobilization state for assets with immobilizer accessories. Immobilization status has high priority and overrides Engine and Transit status when immobilized.

### 1.2 Context

Immobilization status is computed after Connectivity (if online). It has higher priority than Engine and Transit status families. Only applies to assets with immobilizer capability.

### 1.3 Value Proposition

Enables accurate immobilization state detection for marker display and security features. Critical for displaying immobilized status on markers.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Immobilization Rules:**
- **immobilized**: Immobilizer is active and engine is locked
- **immobilizing**: Immobilizer is being activated (transition state)
- **releasing**: Immobilizer is being deactivated (transition state)
- **free**: Immobilizer is inactive

**Compatibility:**
- Only applies to assets with immobilizer accessories
- Check: `asset.accessories?.some(acc => acc.type_code === "immobilizer")`

**Priority:**
- Immobilization has higher priority than Engine and Transit
- Lower priority than Connectivity

**Transition States:**
- **immobilizing/releasing**: Temporary states during immobilization changes
- Duration and detection logic to be defined

### 2.2 States & Behaviors

**Immobilization States:**
- **immobilized**: Asset is immobilized
- **immobilizing**: Immobilization in progress
- **releasing**: Release in progress
- **free**: Not immobilized

**State Transitions:**
- **free → immobilizing → immobilized**: Immobilization sequence
- **immobilized → releasing → free**: Release sequence

### 2.3 Edge Cases

- **No Immobilizer Capability**: Status not computed (not applicable)
- **Missing Immobilizer Signals**: Assume free (safety)
- **Conflicting Signals**: Log warning, use most restrictive state

---

## 3. Technical Specification

### 3.1 Inputs

- **diagnostics.security.immobilizer.engine_lock_active**: Engine lock state
- **diagnostics.security.immobilizer.request_lock_engine**: Lock request state
- **io.outputs.individual.output_N**: Immobilizer output (if available)
- **asset.accessories[]**: Asset accessories (for capability check)

### 3.2 Processing Logic

1. Check immobilizer capability from asset.accessories
2. If no capability, skip computation
3. Evaluate immobilizer signals
4. Determine immobilization state
5. Detect transition states (immobilizing/releasing)
6. Return immobilization status

### 3.3 Outputs

- **Immobilization Status**: `{ family: "immobilization", code: "immobilized" | "immobilizing" | "releasing" | "free", last_changed_at: number }`
- **Compatibility**: Assets with immobilizer accessories only

### 3.4 Data Structures

```json
{
  "family": "immobilization",
  "code": "immobilized",
  "last_changed_at": 1234567890123
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Fleeti Fields Database  
**Usage:** Reference immobilizer diagnostic fields

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Missing immobilizer fields must be handled. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 – Compute Immobilized Status

**Given** asset has immobilizer and is immobilized  
**When** computing immobilization status  
**Then** status is "immobilized"

### AC2 – Compute Free Status

**Given** asset has immobilizer and is not immobilized  
**When** computing immobilization status  
**Then** status is "free"

### AC3 – Skip Non-Immobilizer Assets

**Given** asset does not have immobilizer capability  
**When** computing status  
**Then** immobilization status is not computed

---

## 7. Performance Requirements

- **Latency:** Immobilization computation < 2ms
- **Throughput:** Handle computation at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Immobilized state
- Free state
- Transition states (immobilizing/releasing)
- Capability check
- Missing signal handling

### 8.2 Integration Tests

- End-to-end immobilization computation with real telemetry
- Status transition scenarios
- Asset capability scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 3 Overview](./README.md)**: Epic context
- **[Status Rules](./status-rules.md)**: Immobilization status rules (legacy reference)

---

## 10. Non-Goals

- Other status families (covered by F3.1, F3.2, F3.3)
- Top status computation (covered by F3.5)

---

## 11. Open Questions

1. How are transition states (immobilizing/releasing) detected?
2. What is the duration of transition states?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

