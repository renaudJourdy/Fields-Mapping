**Epic:** E3 – Status Computation  
**Depends on:** F3.1 (Connectivity), F3.2 (Transit), F3.3 (Engine), F3.4 (Immobilization)  
**Related Features:** All status family features (F3.1-F3.4)

---

## 1. Description

Compute the top status (highest-priority status family) for marker display and frontend consumption. Top status determines which status is most critical and should be displayed.

### 1.1 Purpose

Select the highest-priority status family from all computed status families. Top status is used for marker iconography on the live map and determines visual representation of asset state.

### 1.2 Context

After all status families are computed (F3.1-F3.4), top status selects the most critical status based on priority hierarchy. Top status is included in WebSocket contracts for marker display.

### 1.3 Value Proposition

Enables consistent marker display logic by providing a single status value that represents the most critical asset state. Critical for frontend marker rendering.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Priority Hierarchy (must be applied in this exact order):**
1. **Connectivity** (offline overrides everything)
2. **Immobilization** (immobilized > immobilizing/releasing > free)
3. **Engine** (running > standby)
4. **Transit** (in_transit > parked)

**Top Status Selection:**
- Evaluate status families in priority order
- Select first applicable status family
- If higher-priority family is active, lower-priority families are not considered

**Compatibility Considerations:**
- Only consider status families that are compatible with asset type
- Example: Immobilization only applies to assets with immobilizer accessories
- Example: Engine only applies to assets with engines

**Asset Type Compatibility:**
- **Vehicles**: All status families apply
- **Equipment**: Connectivity, Engine, Transit apply (Immobilization if equipped)
- **Sites**: Connectivity applies (other families may apply based on site type)
- **Phones**: Connectivity applies only

### 2.2 States & Behaviors

**Top Status Values:**
- **offline**: Connectivity = offline (highest priority)
- **immobilized**: Immobilization = immobilized
- **immobilizing**: Immobilization = immobilizing
- **releasing**: Immobilization = releasing
- **running**: Engine = running (when not immobilized)
- **in_transit**: Transit = in_transit (when not immobilized, not running)
- **parked**: Transit = parked (when not immobilized, not running)
- **online**: Connectivity = online, no other family active (default)

**Behaviors:**
- Top status reflects the most critical operational state
- Lower-priority statuses are still available in `statuses[]` array
- Top status changes trigger marker icon updates

### 2.3 Edge Cases

- **All Status Families Inactive**: Use default "online" status
- **Multiple Families Active**: Select highest-priority family
- **Compatibility Conflicts**: Only consider compatible status families
- **Missing Status Families**: Skip missing families, evaluate available ones

---

## 3. Technical Specification

### 3.1 Inputs

- **Status Families**: Array of computed status families from F3.1-F3.4
- **Asset Type**: Asset type for compatibility checking
- **Asset Metadata**: Asset accessories for capability checking

### 3.2 Processing Logic

1. Collect all computed status families
2. Filter by asset type compatibility
3. Evaluate in priority order:
   - If Connectivity = offline → top_status = "offline" (stop)
   - If Immobilization applicable and active → top_status = immobilization code (stop)
   - If Engine applicable and running → top_status = "running" (stop)
   - If Transit applicable and in_transit → top_status = "in_transit" (stop)
   - If Transit applicable and parked → top_status = "parked" (stop)
4. Default: top_status = "online"
5. Return top status with last_changed_at

### 3.3 Outputs

- **Top Status**: `{ family: string, code: string, last_changed_at: number }`
- **Statuses Array**: All computed status families for reference

### 3.4 Data Structures

```json
{
  "top_status": {
    "family": "transit",
    "code": "in_transit",
    "last_changed_at": 1234567890123
  },
  "statuses": [
    { "family": "connectivity", "code": "online", "last_changed_at": 1234567890000 },
    { "family": "transit", "code": "in_transit", "last_changed_at": 1234567890123 }
  ]
}
```

---

## 4. Integration & Contracts

### 4.1 API Contracts

**WebSocket Contract:** [`../websocket-contracts/live-map-markers.md`](../websocket-contracts/live-map-markers.md)

Top status is included in WebSocket marker stream for frontend consumption.

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Top status computation must handle missing status families gracefully. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 – Select Highest-Priority Status

**Given** multiple status families are active  
**When** computing top status  
**Then** highest-priority status family is selected

### AC2 – Handle Offline Override

**Given** Connectivity = offline  
**When** computing top status  
**Then** top status is "offline" regardless of other statuses

### AC3 – Apply Compatibility

**Given** status families and asset type  
**When** computing top status  
**Then** only compatible status families are considered

---

## 7. Performance Requirements

- **Latency:** Top status computation < 1ms
- **Throughput:** Handle computation at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Priority hierarchy evaluation
- Offline override
- Compatibility filtering
- Multiple active families
- Default online status

### 8.2 Integration Tests

- End-to-end top status computation with all status families
- Asset type compatibility scenarios
- WebSocket contract integration

---

## 9. References

### 9.1 Related Documentation

- **[Epic 3 Overview](./README.md)**: Epic context
- **[Status Family Features](./F3.1-Compute-Connectivity-Status.md)**: Status family computation
- **[WebSocket Contracts](../websocket-contracts/live-map-markers.md)**: Top status usage

---

## 10. Non-Goals

- Status family computation (covered by F3.1-F3.4)
- Marker rendering logic (frontend responsibility)

---

## 11. Open Questions

1. What are the exact compatibility matrices for each asset type?
2. Should top status include transition states (immobilizing/releasing)?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

