# F3.2 – Compute Transit Status

**Epic:** E3 – Status Computation  
**Depends on:** E2 (transformed Fleeti fields: `motion.is_moving`, `power.ignition`)  
**Related Features:** F3.5 (Compute Top Status)

---

## 1. Description

Compute Transit status (in_transit/parked) based on motion and ignition state.

### 1.1 Purpose

Determine whether an asset is currently moving or parked. Transit status is used for marker display and trip detection.

### 1.2 Context

Transit status is computed after Connectivity (if online). It has lower priority than Immobilization and Engine status families.

### 1.3 Value Proposition

Enables accurate movement state detection for marker display and trip tracking. Provides consistent transit status regardless of provider.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Transit Rules:**
- **in_transit**: `motion.is_moving.value = true` OR (`power.ignition = true` AND speed > threshold)
- **parked**: `motion.is_moving.value = false` AND (`power.ignition = false` OR speed ≤ threshold)

**Compatibility:**
- Applies to movable assets (vehicles, equipment)
- Does not apply to sites (fixed location assets)

**Priority:**
- Transit has lower priority than Immobilization and Engine
- Only evaluated if Connectivity = online and Immobilization/Engine don't override

### 2.2 States & Behaviors

**Transit States:**
- **in_transit**: Asset is moving
- **parked**: Asset is stationary

**State Transitions:**
- **parked → in_transit**: Motion detected or ignition on with speed
- **in_transit → parked**: Motion stopped and ignition off or low speed

### 2.3 Edge Cases

- **Missing motion.is_moving**: Use speed and ignition as fallback
- **Missing speed**: Use motion.is_moving if available
- **Conflicting Signals**: Prefer motion.is_moving over speed

---

## 3. Technical Specification

### 3.1 Inputs

- **motion.is_moving.value**: Boolean movement indicator
- **motion.speed**: Speed value (km/h)
- **power.ignition**: Ignition state
- **asset.type**: Asset type (for compatibility)

### 3.2 Processing Logic

1. Check asset type compatibility (movable assets only)
2. Evaluate motion.is_moving if available
3. Fallback to speed + ignition if motion.is_moving unavailable
4. Determine transit status
5. Return transit status

### 3.3 Outputs

- **Transit Status**: `{ family: "transit", code: "in_transit" | "parked", last_changed_at: number }`
- **Compatibility**: Movable assets only (vehicles, equipment)

### 3.4 Data Structures

```json
{
  "family": "transit",
  "code": "in_transit",
  "last_changed_at": 1234567890123
}
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Fleeti Fields Database  
**Usage:** Reference `motion.is_moving`, `motion.speed`, `power.ignition` fields

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Missing motion fields must be handled with fallbacks. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 – Compute In-Transit Status

**Given** asset is moving  
**When** computing transit status  
**Then** status is "in_transit"

### AC2 – Compute Parked Status

**Given** asset is stationary  
**When** computing transit status  
**Then** status is "parked"

### AC3 – Handle Missing Fields

**Given** motion.is_moving is missing  
**When** computing transit status  
**Then** fallback to speed + ignition logic

---

## 7. Performance Requirements

- **Latency:** Transit computation < 2ms
- **Throughput:** Handle computation at transformation rate

---

## 8. Testing Strategy

### 8.1 Unit Tests

- In-transit with motion.is_moving
- Parked with motion.is_moving
- Fallback to speed + ignition
- Asset type compatibility

### 8.2 Integration Tests

- End-to-end transit computation with real telemetry
- Status transition scenarios
- Missing field fallbacks

---

## 9. References

### 9.1 Related Documentation

- **[Epic 3 Overview](./README.md)**: Epic context
- **[Status Rules](./status-rules.md)**: Transit status rules (legacy reference)

---

## 10. Non-Goals

- Other status families (covered by F3.1, F3.3, F3.4)
- Top status computation (covered by F3.5)

---

## 11. Open Questions

1. What is the exact speed threshold for transit detection?
2. How should conflicting motion signals be resolved?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

