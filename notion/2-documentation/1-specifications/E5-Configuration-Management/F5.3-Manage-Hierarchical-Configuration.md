# F5.3 – Manage Hierarchical Configuration

**Epic:** E5 – Configuration & Management  
**Depends on:** F5.2 (Store and Version Configuration)  
**Related Features:** F5.4 (Deploy Configuration)

---

## 1. Description

Manage hierarchical configuration at multiple levels (default, customer, asset group, asset). Support configuration overrides and merging.

### 1.1 Purpose

Enable customer-specific and asset-specific configuration customization. Lower-level configurations override higher-level configurations.

### 1.2 Context

After configurations are stored (F5.2), hierarchical management enables multi-level configuration. When transformation pipeline loads configuration (Epic 2), it merges configurations from all levels.

### 1.3 Value Proposition

Enables flexible configuration customization per customer, asset group, or individual asset. Supports different mapping preferences without code changes.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Hierarchy Levels:**
1. **Default/Global**: Base configuration for all assets
2. **Customer**: Override default for specific customer
3. **Asset Group**: Override customer configuration for asset group
4. **Asset**: Override group configuration for specific asset

**Merging Rules:**
- Lower-level configurations override higher-level configurations
- Partial overrides merge with parent configuration
- Missing configurations fall back to parent level

**Example:**
```
Default: speed = can_speed > obd_speed > gps_speed
Customer A: speed = obd_speed > gps_speed (CAN not available)
Asset Group "Fleet B": speed = gps_speed (OBD unreliable)
Asset "Truck-123": speed = can_speed (highest priority)
```

### 2.2 States & Behaviors

**Configuration States:**
- **Active**: Configuration is active and used
- **Draft**: Configuration is being edited, not yet active
- **Deprecated**: Configuration is deprecated, will be removed

**Behaviors:**
- Support configuration at each level
- Merge configurations when loading
- Validate merged configuration

### 2.3 Edge Cases

- **Missing Levels**: Use parent level configuration
- **Conflicting Overrides**: Lower level wins
- **Invalid Merges**: Validate and reject invalid merges

---

## 3. Technical Specification

### 3.1 Inputs

- **Configuration Levels**: Default, customer, group, asset configurations
- **Asset Context**: Customer ID, asset group ID, asset ID

### 3.2 Processing Logic

1. Load default configuration
2. Load customer configuration (if exists)
3. Load asset group configuration (if exists)
4. Load asset-specific configuration (if exists)
5. Merge configurations (lower levels override higher)
6. Validate merged configuration
7. Return merged configuration

### 3.3 Outputs

- **Merged Configuration**: Complete configuration for asset
- **Configuration Sources**: Which levels were used
- **Validation Result**: Configuration validity

### 3.4 Data Structures

```yaml
# Merged configuration example
mappings:
  motion.speed:
    sources:
      - priority: 1
        field: "can_speed"  # From asset-level override
```

---

## 4. Integration & Contracts

### 4.2 Database Schema

**Database:** Configuration Storage  
**Usage:** Store and retrieve configurations at each level

---

## 5. Cross-Cutting Concerns

### 5.2 Data Quality

**Reference:** [`../../6-data-quality/README.md`](../../6-data-quality/README.md)

Merged configuration must be validated. See data quality documentation.

---

## 6. Acceptance Criteria

### AC1 – Merge Hierarchical Configuration

**Given** configurations exist at multiple levels  
**When** merging configurations  
**Then** lower-level configurations override higher-level configurations

### AC2 – Handle Missing Levels

**Given** a configuration level is missing  
**When** merging configurations  
**Then** system falls back to parent level configuration

### AC3 – Validate Merged Configuration

**Given** configurations are merged  
**When** validating merged configuration  
**Then** merged configuration passes validation

---

## 7. Performance Requirements

- **Merging Latency:** Efficient configuration merging
- **Configuration Loading:** Fast configuration retrieval (< 10ms with caching)

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Configuration merging logic
- Override behavior
- Missing level fallback
- Validation logic

### 8.2 Integration Tests

- End-to-end hierarchical configuration with real data
- Configuration loading scenarios
- Merge validation

---

## 9. References

### 9.1 Related Documentation

- **[Epic 5 Overview](./README.md)**: Epic context
- **[Epic 2 - Field Mapping](../E2-Field-Mapping-Transformation/F2.1-Load-Hierarchical-Configuration.md)**: Configuration usage

---

## 10. Non-Goals

- Configuration generation (covered by F5.1)
- Configuration deployment (covered by F5.4)

---

## 11. Open Questions

1. How should configuration conflicts be resolved?
2. What is the optimal caching strategy?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

