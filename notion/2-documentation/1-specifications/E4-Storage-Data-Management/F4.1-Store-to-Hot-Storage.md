**Epic:** E4 â€“ Storage & Data Management  
**Depends on:** E2 (transformed Fleeti telemetry), E3 (status computation)  
**Related Features:** F4.2 (Store to Warm Storage)

---

## 1. Description

Store core telemetry fields (~25-30 fields) to hot storage for fast real-time access (< 100ms latency). Hot storage is optimized for map display and live tracking.

### 1.1 Purpose

Enable fast access to core telemetry fields needed for real-time map updates. Hot storage is optimized for read performance and low latency.

### 1.2 Context

After telemetry is transformed (Epic 2) and status is computed (Epic 3), core fields are written to hot storage. Hot storage is queried by WebSocket streams and REST APIs for live map display.

### 1.3 Value Proposition

Enables < 100ms access to core fields for real-time map updates. Critical for smooth marker updates and live tracking experience.

---

## 2. Business Logic

### 2.1 Rules & Priority

**Core Fields Stored:**
- Location (latitude, longitude, heading)
- Motion (speed, is_moving)
- Status (top_status, statuses[])
- Asset metadata (id, type)
- Timestamps (last_updated_at)

**Storage Rules:**
- Store only core fields (~25-30 fields)
- Optimize for read performance
- Retention: Last 30 days
- Update on every telemetry packet

### 2.2 States & Behaviors

**Storage States:**
- **Stored**: Core fields written successfully
- **Failed**: Write failure, retry or alert

**Behaviors:**
- Asynchronous write (non-blocking)
- Batch writes for efficiency
- Verify write success

### 2.3 Edge Cases

- **Storage Unavailable**: Queue writes, retry, alert
- **Write Failure**: Retry with backoff, alert if persistent
- **Field Missing**: Store null or omit field

---

## 3. Technical Specification

### 3.1 Inputs

- **Core Telemetry Fields**: ~25-30 fields from Fleeti telemetry
- **Status**: Top status and statuses array
- **Asset ID**: Asset identifier

### 3.2 Processing Logic

1. Extract core fields from complete telemetry
2. Prepare hot storage record
3. Write to hot storage (asynchronous)
4. Verify write success
5. Handle failures with retry

### 3.3 Outputs

- **Storage Result**: Success/failure
- **Storage Location**: Reference for queries

### 3.4 Data Structures

```json
{
  "asset_id": "uuid",
  "timestamp": 1234567890123,
  "location": { "latitude": 14.6661, "longitude": -17.0712, "heading": 92.0 },
  "motion": { "speed": 45.2, "is_moving": true },
  "status": { "top_status": "in_transit", "statuses": [...] }
}
```

---

## 4. Integration & Contracts

### 4.3 External Service Integration

**Service:** Hot Storage System  
**Integration Type:** Storage API or direct write  
**Performance:** < 100ms read latency required

---

## 5. Cross-Cutting Concerns

### 5.3 Error Handling

**Reference:** [`../../5-operations/error-handling.md`](../../5-operations/error-handling.md)

Storage failures are critical and must be handled with immediate alerts. See error handling documentation.

### 5.4 Monitoring & Observability

**Reference:** [`../../5-operations/monitoring-observability.md`](../../5-operations/monitoring-observability.md)

Must emit metrics: `telemetry.storage.hot.writes`, `telemetry.storage.hot.write.errors`, `telemetry.storage.hot.read.latency`. See monitoring documentation.

---

## 6. Acceptance Criteria

### AC1 â€“ Store Core Fields

**Given** transformed telemetry and status  
**When** storing to hot storage  
**Then** core fields are stored correctly

### AC2 â€“ Meet Latency Requirements

**Given** hot storage is queried  
**When** reading core fields  
**Then** read latency is < 100ms

### AC3 â€“ Handle Storage Failures

**Given** hot storage is unavailable  
**When** attempting to write  
**Then** writes are queued, retried, and alerts triggered

---

## 7. Performance Requirements

- **Write Latency:** Asynchronous (non-blocking)
- **Read Latency:** < 100ms for core fields
- **Throughput:** Handle peak ingestion rate
- **Retention:** Last 30 days

---

## 8. Testing Strategy

### 8.1 Unit Tests

- Core field extraction
- Hot storage write operation
- Failure handling

### 8.2 Integration Tests

- End-to-end storage with real telemetry
- Read latency testing
- Failure scenarios

---

## 9. References

### 9.1 Related Documentation

- **[Epic 4 Overview](./README.md)**: Epic context
- **[ðŸ“ WebSocket Contracts](../websocket-contracts/live-map-markers.md)**: Hot storage usage

---

## 10. Non-Goals

- Complete field storage (covered by F4.2)
- Historical data (covered by F4.2)

---

## 11. Open Questions

1. What is the exact hot storage implementation?
2. What are the exact core fields to store?

---

## 12. Change History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-01-XX | 1.0 | [Author] | Initial feature specification |

