# Description

Automatically synchronizes customer data forwarding configuration from the customer database to ensure data forwarding connections match the expected customer list. Validates that customers with Navixy provider have proper setup (at least one gateway/asset) and maintains consistency between the customer database and active data forwarding connections. Detects and resolves discrepancies between expected and actual connections.

**Value Delivered:**

- Automated consistency between customer database and data forwarding connections
- Early detection of connection setup issues and discrepancies
- Reduced manual management overhead for customer synchronization
- Validation that customers meet requirements before establishing connections
- Correlation monitoring between connection count and customer count

**System Context:**

This feature synchronizes customer data forwarding configuration from the customer database (source of truth) and ensures connections managed by F1.1 (Navixy Data Forwarding Integration) match expected customers. It complements F1.3 (Customer Management for Data Forwarding) which provides manual control, while this feature provides automated synchronization. The feature validates customer requirements (Navixy provider association, gateway/asset availability) before establishing connections and maintains correlation between connection count and customer count.

---

# Business Logic / Processing Logic

## Core Rules and Priorities

**Customer Database as Source of Truth:**

- Customer database is the authoritative source for customer list and provider associations
- Synchronization reads from customer database and updates data forwarding configuration accordingly
- Manual changes via F1.3 take precedence over automatic synchronization for the same customer

**Customer State Rules:**

- Only `active` (non-suspended) customers should have data forwarding connections
- `suspended` customers should NOT have data forwarding connections (connections must be closed)
- `removed` customers should NOT have data forwarding connections (connections must be closed)

**Customer Requirements:**

- Customers with Navixy provider must have at least one gateway/asset before connection can be established
- Customers must have valid Navixy hash for connection establishment
- Customers missing requirements are skipped (no connection established) but logged for investigation

**Connection Correlation:**

- Connection count should match expected customer count (active customers with Navixy provider and gateways)
- Discrepancies between connection count and customer count trigger investigation
- Missing connections are automatically established for eligible customers
- Extra connections (without matching customers) are automatically closed

**Synchronization Schedule:**

- Daily polling of customer database
- Synchronization runs at scheduled time (configurable)
- Failed synchronizations are retried on next cycle

## Processing Steps

### Daily Synchronization Workflow

1. **Poll Customer Database**

   - Query customer database for all customers
   - Filter customers with Navixy provider association
   - Extract customer state (active/suspended/removed)
   - Extract customer Navixy hash for connection
   - Extract customer reference/identifier

2. **Validate Customer Requirements**

   - For each customer with Navixy provider:
     - Verify customer has at least one gateway/asset
     - Verify customer has valid Navixy hash
     - Mark customers missing requirements (skip for connection establishment)
   - Generate list of eligible customers (active, Navixy provider, has gateways, has hash)

3. **Query Active Connections**

   - Query F1.1 for all active Navixy connections
   - Extract connection details (customer reference, connection status)
   - Count active connections

4. **Compare and Identify Discrepancies**

   - Compare expected customer count (eligible customers) with actual connection count
   - Identify missing connections (eligible customers without active connections)
   - Identify extra connections (active connections without matching eligible customers)
   - Identify suspended/removed customers with active connections (should be closed)
   - Generate discrepancy report

5. **Resolve Missing Connections**

   - For each eligible customer without connection:
     - Trigger F1.1 to establish Navixy connection using customer hash
     - Monitor connection establishment status
     - Log connection establishment success or failure
   - Hash-based connection includes all gateways (no individual gateway specification needed)

6. **Resolve Invalid Connections**

   - For each active connection without matching eligible customer:
     - Identify customer reference from connection
     - Check customer state in database
     - If customer is suspended/removed or missing: trigger F1.1 to close connection
     - Log connection closure action
   - For each suspended/removed customer with active connection:
     - Trigger F1.1 to close Navixy connection
     - Verify connection closure
     - Log connection closure action

7. **Validate Synchronization Results**

   - Verify connection count matches expected customer count (eligible customers)
   - Verify all eligible customers have active connections
   - Verify no suspended/removed customers have active connections
   - Verify no customers without gateways have connections

8. **Log Synchronization Results**

   - Log synchronization execution timestamp and duration
   - Log discrepancies found (missing connections, extra connections, suspended customers with connections)
   - Log actions taken (connections established, connections closed)
   - Log customers skipped (missing requirements)
   - Generate synchronization summary report

## Edge Cases and Error Handling

**Customer Database Unavailable:**

- **Condition:** Customer database is unavailable during synchronization
- **Handling:** Skip synchronization cycle, log error, retry on next scheduled cycle
- **Reason:** Temporary database unavailability should not cause system failure

**Customer Missing Navixy Hash:**

- **Condition:** Customer has Navixy provider but missing hash
- **Handling:** Skip customer for connection establishment, log warning, require manual setup via F1.3
- **Reason:** Cannot establish connection without valid hash

**Customer Missing Gateways:**

- **Condition:** Customer has Navixy provider but no gateways/assets
- **Handling:** Skip customer for connection establishment, log warning, do not establish connection
- **Reason:** Connection should only be established when customer has at least one gateway

**F1.1 Connection Establishment Failure:**

- **Condition:** F1.1 fails to establish connection for eligible customer
- **Handling:** Log error with customer details, mark connection as failed, allow retry on next sync cycle
- **Reason:** Connection failures should be tracked but not block synchronization of other customers

**F1.1 Connection Closure Failure:**

- **Condition:** F1.1 fails to close connection for suspended/removed customer
- **Handling:** Log error, attempt retry, mark for investigation if persistent
- **Reason:** Connections must be closed to maintain consistency

**Connection Count Mismatch:**

- **Condition:** Connection count does not match expected customer count after synchronization
- **Handling:** Log discrepancy, trigger investigation workflow, generate alert
- **Reason:** Persistent mismatches indicate system inconsistency requiring investigation

**Suspended Customer Has Active Connection:**

- **Condition:** Suspended customer still has active data forwarding connection
- **Handling:** Close connection immediately, log action, verify closure
- **Reason:** Suspended customers should not receive data forwarding

**Customer State Changed During Synchronization:**

- **Condition:** Customer state changes in database while synchronization is running
- **Handling:** Use state at start of synchronization, handle state changes in next cycle
- **Reason:** Avoid race conditions and ensure consistent synchronization

## State Management

**Customer States:**

| State | Description | Data Forwarding Connection |
|-------|-------------|---------------------------|
| `active` | Customer enabled for data forwarding | Connection should be established |
| `suspended` | Customer temporarily disabled | Connection should be closed |
| `removed` | Customer removed from system | Connection should be closed |

**Connection States:**

| State | Description | Action Required |
|-------|-------------|-----------------|
| `connected` | Connection active and receiving data | None (if customer eligible) |
| `disconnected` | Connection closed | Establish (if customer eligible) |
| `pending` | Connection establishment in progress | Monitor completion |
| `failed` | Connection establishment failed | Retry on next sync cycle |

**Synchronization States:**

| State | Description | Next Action |
|-------|-------------|-------------|
| `pending` | Synchronization scheduled | Execute at scheduled time |
| `in_progress` | Synchronization currently running | Complete processing |
| `completed` | Synchronization completed successfully | Schedule next cycle |
| `failed` | Synchronization failed | Retry on next cycle |

## External Service Contracts

**Customer Database:**

- **Source:** Customer database (internal or external)
- **Query Method:** Database query (structure depends on database implementation)
- **Data Retrieved:** Customer reference, provider associations, customer state, Navixy hash
- **Query Frequency:** Daily (configurable schedule)
- **Error Handling:** Retry on failure, skip cycle if database unavailable

**F1.1 Integration:**

- **Purpose:** Establish and close Navixy data forwarding connections
- **Connection Method:** Hash-based connection (includes all gateways for customer)
- **Operations:** Establish connection, close connection, query active connections
- **Error Handling:** Log failures, allow retries, track connection status

## Connection Management

**Connection Lifecycle:**

- **Establishment:** Triggered when eligible customer is found without connection
- **Maintenance:** Connections maintained by F1.1, this feature ensures they match customer list
- **Closure:** Triggered when customer is suspended/removed or no longer eligible
- **Verification:** Connection status verified after establishment/closure operations

**Hash-Based Connection:**

- **Method:** Uses customer Navixy hash for connection subscription
- **Scope:** Includes all gateways for the customer (no individual gateway specification needed)
- **Benefit:** Simplified connection management, automatic inclusion of all customer gateways

## Error Handling

**Retry Logic:**

- **Database Unavailable:** Retry on next scheduled synchronization cycle
- **Connection Establishment Failure:** Retry on next synchronization cycle
- **Connection Closure Failure:** Immediate retry, then retry on next cycle if persistent

**Error Classification:**

- **Temporary Errors:** Database unavailability, transient connection failures → Retry automatically
- **Configuration Errors:** Missing hash, missing gateways → Skip customer, require manual setup
- **System Errors:** Persistent connection failures, count mismatches → Log, alert, investigate

**Failure Modes:**

- **Partial Synchronization:** Some customers synchronized, others failed → Continue processing, report partial success
- **Complete Synchronization Failure:** Database unavailable or system error → Skip cycle, retry next cycle
- **Persistent Discrepancies:** Connection count mismatch persists → Alert, trigger investigation workflow

## Monitoring Metrics

**Key Metrics Tracked:**

| Metric | Description | Collection Point | Threshold |
|--------|-------------|------------------|-----------|
| Synchronization Success Rate | Percentage of successful sync cycles | Sync cycle completion | > 95% |
| Discrepancy Count | Number of discrepancies found per sync | Discrepancy detection | 0 (ideal) |
| Missing Connections | Count of eligible customers without connections | Comparison step | 0 (ideal) |
| Extra Connections | Count of connections without matching customers | Comparison step | 0 (ideal) |
| Suspended Customers with Connections | Count of suspended customers with active connections | Comparison step | 0 (ideal) |
| Connection Count Accuracy | Difference between expected and actual count | Validation step | 0 (perfect match) |
| Customers Skipped | Count of customers skipped (missing requirements) | Validation step | Track trend |
| Sync Duration | Time to complete synchronization | Sync start/end | < 5 minutes |
| Connection Establishment Success Rate | Percentage of successful connection establishments | F1.1 integration | > 95% |
| Connection Closure Success Rate | Percentage of successful connection closures | F1.1 integration | > 95% |

**Metric Aggregation:**

- Metrics aggregated per synchronization cycle
- Metrics tracked over time for trend analysis
- Metrics available in monitoring dashboard
- Metrics used for alerting and investigation

## Alerting Rules

**Alert Conditions:**

| Condition | Severity | Threshold | Action |
|-----------|----------|-----------|--------|
| Synchronization Failure | High | Sync fails | Alert operations team, retry next cycle |
| Persistent Discrepancies | Medium | Discrepancies persist > 2 cycles | Alert operations team, trigger investigation |
| Connection Count Mismatch | High | Count mismatch after sync | Alert operations team, investigate immediately |
| Suspended Customers with Connections | High | Any suspended customer has connection | Alert immediately, close connection |
| High Customer Skip Rate | Low | > 10% customers skipped | Review customer requirements, investigate |
| Connection Establishment Failure Rate | Medium | < 90% success rate | Investigate F1.1 connection issues |

**Alert Notification:**

- Alerts sent to operations team
- Alerts include synchronization summary and discrepancy details
- Alerts integrated with monitoring dashboard
- Critical alerts trigger immediate investigation

## Audit Trail Logic

**Events Logged:**

| Event | Logged Information | Retention |
|-------|-------------------|-----------|
| Synchronization Started | Timestamp, sync cycle ID | Permanent |
| Synchronization Completed | Timestamp, sync cycle ID, duration, success/failure | Permanent |
| Customer Database Query | Timestamp, customer count retrieved, query status | 1 year |
| Eligible Customers Identified | Timestamp, eligible customer count, customer references | Permanent |
| Missing Connections Detected | Timestamp, customer references, count | Permanent |
| Extra Connections Detected | Timestamp, connection details, count | Permanent |
| Connection Established | Timestamp, customer reference, connection status | Permanent |
| Connection Closed | Timestamp, customer reference, reason, connection status | Permanent |
| Customer Skipped | Timestamp, customer reference, reason (missing hash/gateways) | Permanent |
| Discrepancy Resolved | Timestamp, discrepancy type, resolution action | Permanent |
| Synchronization Failure | Timestamp, error details, retry scheduled | Permanent |

**Log Format:**

- Structured logging with timestamp, event type, customer reference (if applicable), details, status
- Logs queryable by timestamp, event type, customer reference, sync cycle ID
- Logs integrated with investigation tools and monitoring dashboard

**Log Querying:**

- Query by sync cycle ID to view complete synchronization history
- Query by customer reference to view all synchronization events for specific customer
- Query by event type to view all connection establishments, closures, etc.
- Query by date range for historical analysis
- Query by discrepancy type for trend analysis

## Investigation Workflows

**Investigation Triggers:**

- Persistent connection count mismatches
- Synchronization failures
- Customers repeatedly skipped (missing requirements)
- Suspended customers with active connections
- High discrepancy rates

**Investigation Steps:**

1. **Review Synchronization Logs**

   - Query audit trail for recent synchronization cycles
   - Review synchronization success/failure history
   - Identify patterns in discrepancies or failures

2. **Analyze Customer Database and Connection Status**

   - Verify customer database is accessible and up-to-date
   - Check customer state accuracy and provider associations
   - Verify customer hashes are present and valid
   - Query F1.1 for active connections and compare with expected connections
   - Review connection establishment/closure logs

3. **Validate Customer Requirements and F1.1 Integration**

   - Verify customers have required gateways/assets and valid Navixy hashes
   - Review customer requirement validation logs
   - Review F1.1 connection establishment/closure success rates
   - Check for F1.1 errors or failures

4. **Identify Root Cause**

   - Correlate synchronization issues with system events
   - Check for database connectivity issues
   - Review F1.1 connection management issues
   - Identify configuration or data quality problems

5. **Determine Resolution**

   - Fix database connectivity if needed
   - Resolve F1.1 connection issues if needed
   - Update customer data if incorrect
   - Manually establish/close connections if needed
   - Schedule retry synchronization if appropriate

**Data Sources:**

- Synchronization audit trail logs
- Customer database queries
- F1.1 connection status and logs
- Customer requirement validation logs
- Monitoring metrics and alerts

**Investigation Tools:**

- Synchronization audit trail query interface
- Customer database query interface
- F1.1 connection status dashboard
- Monitoring dashboard with metrics
- Error log viewer

---

# Acceptance Criteria

## AC1 - Daily Synchronization Executes Successfully

**Given** synchronization is scheduled to run daily  
**When** synchronization cycle executes  
**Then** customer database is queried successfully, customers with Navixy provider are identified, customer states and hashes are extracted, and synchronization proceeds to validation step

## AC2 - Customer Requirements Validated

**Given** customers with Navixy provider are identified  
**When** customer requirements are validated  
**Then** customers with at least one gateway and valid hash are marked as eligible, customers missing gateways are skipped and logged, customers missing hash are skipped and logged, and eligible customer list is generated

## AC3 - Active Connections Queried

**Given** eligible customers are identified  
**When** active connections are queried  
**Then** F1.1 is queried for all active Navixy connections, connection details are extracted, connection count is calculated, and connection data is prepared for comparison

## AC4 - Discrepancies Detected

**Given** eligible customers and active connections are identified  
**When** comparison is performed  
**Then** missing connections are identified (eligible customers without connections), extra connections are identified (connections without matching eligible customers), suspended customers with connections are identified, and discrepancy report is generated

## AC5 - Missing Connections Established

**Given** eligible customers without connections are identified  
**When** missing connections are resolved  
**Then** F1.1 is triggered to establish connection for each eligible customer, hash-based connection is used (includes all gateways), connection establishment status is monitored, and establishment success/failure is logged

## AC6 - Invalid Connections Closed

**Given** invalid connections are identified (extra connections or suspended/removed customers with connections)  
**When** invalid connections are resolved  
**Then** customer reference is identified from connection, customer state is checked in database, F1.1 is triggered to close connection, connection closure is verified, and closure action is logged

## AC7 - Synchronization Results Validated

**Given** synchronization actions are completed  
**When** synchronization results are validated  
**Then** connection count matches expected customer count, all eligible customers have active connections, no suspended/removed customers have active connections, and no customers without gateways have connections

## AC8 - Synchronization Results Logged

**Given** synchronization completes (success or failure)  
**When** synchronization results are logged  
**Then** synchronization execution is logged with timestamp and duration, discrepancies found are logged with details, actions taken are logged (connections established/closed), customers skipped are logged with reasons, and synchronization summary report is generated

## AC9 - Customer Database Unavailable Handled

**Given** customer database is unavailable during synchronization  
**When** synchronization attempts to query database  
**Then** synchronization cycle is skipped, error is logged, retry is scheduled for next cycle, and system continues operating normally

## AC10 - Connection Establishment Failure Handled

**Given** eligible customer requires connection establishment  
**When** F1.1 fails to establish connection  
**Then** error is logged with customer details, connection is marked as failed, customer is eligible for retry on next sync cycle, and synchronization continues for other customers

## AC11 - Connection Count Mismatch Detected

**Given** synchronization completes  
**When** connection count does not match expected customer count  
**Then** discrepancy is logged with details, alert is generated, investigation workflow is triggered, and discrepancy is tracked for resolution

## AC12 - Integration with F1.1

**Given** synchronization requires connection management  
**When** connection establishment or closure is needed  
**Then** F1.1 is triggered with correct customer information and hash, connection operation is executed, connection status is verified, and integration success/failure is logged

## AC13 - Integration with F1.3

**Given** manual customer management operations exist via F1.3  
**When** synchronization runs  
**Then** manual changes via F1.3 take precedence for same customer, synchronization does not override manual operations, and manual and automatic operations are logged separately

---

# Related Documentation

- [E1 - Provider Ingestion & Data Forwarding](./README.md)
- [F1.1 - Navixy Data Forwarding Integration](./F1.1-Navixy-Data-Forwarding-Integration.md)
- [F1.3 - Customer Management for Data Forwarding](./F1.3-Customer-Management-for-Data-Forwarding.md)
- [F1.4 - Data Forwarding Health Monitoring](./F1.4-Data-Forwarding-Health-Monitoring.md)

---

# Non-Goals

**Out of Scope:**

- Manual customer operations (handled by F1.3)
- Individual gateway connection management (uses hash for all gateways, no individual gateway specification)
- Real-time synchronization (daily polling only, not event-driven)
- Customer database management (external system, this feature only reads from it)
- Customer credential management (handled by customer system)
- Connection health monitoring details (handled by F1.1 and F1.4)
- Data recovery procedures (handled by F1.5)

**Boundaries:**

- This feature synchronizes customer list from database but does not manage the database itself
- Connection establishment and maintenance details are handled by F1.1
- Manual customer operations are handled by F1.3
- Health monitoring and metrics collection details are handled by F1.4
- This feature ensures consistency but does not prevent all discrepancies (investigation may be needed)

---
